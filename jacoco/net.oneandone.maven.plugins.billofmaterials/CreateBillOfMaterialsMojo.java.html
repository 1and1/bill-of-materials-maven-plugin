<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>CreateBillOfMaterialsMojo.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">1-and-1 :: Bill of Materials Plugin for Maven</a> &gt; <a href="index.source.html" class="el_package">net.oneandone.maven.plugins.billofmaterials</a> &gt; <span class="el_source">CreateBillOfMaterialsMojo.java</span></div><h1>CreateBillOfMaterialsMojo.java</h1><pre class="source lang-java linenums">/**
 * Copyright 1&amp;1 Internet AG, https://github.com/1and1/
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package net.oneandone.maven.plugins.billofmaterials;

import com.google.common.base.*;
import com.google.common.collect.Collections2;
import com.google.common.collect.Lists;
import com.google.common.hash.HashCode;
import com.google.common.hash.HashFunction;
import com.google.common.hash.Hashing;
import com.google.common.io.Files;
import java.io.File;
import java.io.IOException;
import java.util.ArrayList;
import java.util.List;
import java.util.Locale;

import org.apache.maven.artifact.Artifact;
import org.apache.maven.plugin.MojoExecutionException;
import org.apache.maven.plugin.MojoFailureException;
import org.apache.maven.plugins.annotations.LifecyclePhase;
import org.apache.maven.plugins.annotations.Mojo;
import org.apache.maven.project.MavenProject;

/**
 * Creates a bill of materials for all installed artifacts.
 *
 * &lt;p&gt;This in the standard format for the &lt;tt&gt;sha1sum&lt;/tt&gt; command including meta information:&lt;/p&gt;
 * &lt;pre&gt;
 * # company:company-parent-pom:1.0-SNAPSHOT user=mirko
 * 2dcb20b977ff170dd802c30b804229264c97ebf6  company-parent-pom-1.0-SNAPSHOT.pom
 * # company:child1:1.0-SNAPSHOT user=mirko
 * ed5b932c3157b347d0f7a4ec773ae5d5890c1ada  child1-1.0-SNAPSHOT-sources.jar
 * 8294565e2a5d99b548b111fe6262719331436143  child1-1.0-SNAPSHOT.jar
 * 082fa2206c4a00e3f428e9100199a0337ad42fdb  child1-1.0-SNAPSHOT.pom
 * # company:child2:1.0-SNAPSHOT user=mirko
 * 05d419cf53e175c6e84ddc1cf2fccdc9dd109c6b  child2-1.0-SNAPSHOT-sources.jar
 * df633b963220ba124ffa80eb6ceab676934bb387  child2-1.0-SNAPSHOT.jar
 * 5661e9270a02c5359be47615bb6ed9911105d878  child2-1.0-SNAPSHOT.pom
 * &lt;/pre&gt;
 *
 * @author Mirko Friedenhagen &amp;lt;mirko.friedenhagen@1und1.de&amp;gt;
 */
@Mojo(name = &quot;create&quot;, aggregator = false, defaultPhase = LifecyclePhase.INSTALL)
public class CreateBillOfMaterialsMojo extends AbstractBillOfMaterialsMojo {

    /**
     * SHA1 hash function.
     */
<span class="fc" id="L63">    private final HashFunction sha1 = Hashing.sha1();</span>

    /**
     * Function to calculate the hash of a file.
     */
    private final Function&lt;File, String&gt; toBomStringFunction;

    /**
     * Function to get the file from the artifact.
     */
    private final Function&lt;Artifact, File&gt; toFileFunction;

    /**
     * Default constructor for maven.
     */
    CreateBillOfMaterialsMojo() {
<span class="fc" id="L79">        super();</span>
<span class="fc" id="L80">        toFileFunction = new ToFileFunction();</span>
<span class="fc" id="L81">        toBomStringFunction = new ToBomStringFunction(sha1);</span>
<span class="fc" id="L82">    }</span>

    /**
     * Just for tests.
     * @param billOfMaterialsPath path to bom.
     * @param project current project
     */
    CreateBillOfMaterialsMojo(File billOfMaterialsPath, MavenProject project) {
<span class="fc" id="L90">        super(billOfMaterialsPath, project);</span>
<span class="fc" id="L91">        toFileFunction = new ToFileFunction();</span>
<span class="fc" id="L92">        toBomStringFunction = new ToBomStringFunction(sha1);</span>
<span class="fc" id="L93">    }</span>

    @Override
    public void execute() throws MojoExecutionException, MojoFailureException {
        try {
<span class="fc" id="L98">            final List&lt;File&gt; files = getListOfArtifactsAsFiles();</span>
            // We need a copy here as transform will return a fixed size list.
<span class="fc" id="L100">            final List&lt;String&gt; hashBaseNames = new ArrayList&lt;&gt;(Lists.transform(files, toBomStringFunction));</span>
<span class="fc" id="L101">            addHashEntryForPom(hashBaseNames);</span>
<span class="fc" id="L102">            writeResults(hashBaseNames);</span>
<span class="fc" id="L103">        } catch (IOException ex) {</span>
<span class="fc" id="L104">            throw new MojoExecutionException(ex.toString(), ex);</span>
<span class="fc" id="L105">        }</span>
<span class="fc" id="L106">    }</span>

    /**
     * Creates a list of all artifacts for the build.
     * @return a list of all artifacts for the build including the attached ones.
     */
    final List&lt;File&gt; getListOfArtifactsAsFiles() {
<span class="fc" id="L113">        final MavenProject project = getProject();</span>
<span class="fc" id="L114">        final List&lt;Artifact&gt; attachedArtifacts = project.getAttachedArtifacts();</span>
        // We need a copy here as otherwise install and deploy will choke later on because
        // we attach the POM as well.
<span class="fc" id="L117">        final List&lt;File&gt; files = new ArrayList&lt;&gt;(</span>
                Collections2.filter(
                    Lists.transform(attachedArtifacts, toFileFunction),
                        Files.isFile()));
<span class="fc" id="L121">        final String packaging = project.getPackaging();</span>
        // POMs return null as their artifact, which will crash the transformation lateron.
<span class="fc bfc" id="L123" title="All 2 branches covered.">        if (!&quot;pom&quot;.equals(packaging)) {</span>
<span class="fc" id="L124">            files.add(project.getArtifact().getFile());</span>
        }
<span class="fc" id="L126">        return files;</span>
    }

    /**
     * Adds the hash entry for the POM.
     * @param hashBaseNames to add the entry to.
     * @throws IOException when the POM could not be read.
     */
    void addHashEntryForPom(final List&lt;String&gt; hashBaseNames) throws IOException {
<span class="fc" id="L135">        final MavenProject project = getProject();</span>
<span class="fc" id="L136">        final HashCode sha1OfPom = Files.hash(project.getFile(), sha1);</span>
<span class="fc" id="L137">        final String pomLine = String.format(Locale.ENGLISH, &quot;%s  %s-%s.pom&quot;,</span>
                    sha1OfPom, project.getArtifactId(), project.getVersion());
<span class="fc" id="L139">        hashBaseNames.add(pomLine);</span>
<span class="fc" id="L140">    }</span>

    /**
     * Writes the resulting hash file to {@link CreateBillOfMaterialsMojo#billOfMaterialsPath}.
     *
     * @param hashBaseNames to write
     * @throws IOException when the parent directory could not be created or something went wrong while writing the result.
     */
    void writeResults(final List&lt;String&gt; hashBaseNames) throws IOException {
<span class="fc" id="L149">        final String hashBaseNamesAsString = Joiner.on(&quot;\n&quot;).join(hashBaseNames) + &quot;\n&quot;;</span>
<span class="fc" id="L150">        final String userName = System.getProperty(&quot;user.name&quot;);</span>
<span class="fc" id="L151">        write(projectCommentToString(userName));</span>
<span class="fc" id="L152">        write(hashBaseNamesAsString);</span>
<span class="fc" id="L153">    }</span>

    /**
     * Writes content to the bomFile creating intermediate directories.
     *
     * @param content to write
     * @throws IOException when the target directory could not be created or the content could not be written.
     */
    void write(final String content) throws IOException {
<span class="fc" id="L162">        final File bomFile = calculateBillOfMaterialsFile();</span>
<span class="fc" id="L163">        final File parentDirectory = bomFile.getParentFile();</span>
<span class="fc bfc" id="L164" title="All 2 branches covered.">        if (!createParentDirectory(parentDirectory)) {</span>
<span class="fc" id="L165">            throw new IOException(&quot;Could not create parent directory for &quot; + bomFile);</span>
        }
<span class="fc" id="L167">        Files.append(content, bomFile, Charsets.UTF_8);</span>
<span class="fc" id="L168">    }</span>

    /**
     * Returns a string representation for the comment.
     *
     * @param userName current user
     * @return string representation for the comment.
     */
    String projectCommentToString(final String userName) {
<span class="fc" id="L177">        final MavenProject project = getProject();</span>
<span class="fc" id="L178">        return String.format(</span>
                Locale.ENGLISH,
                &quot;# %s:%s:%s user=%s\n&quot;,
                project.getGroupId(), project.getArtifactId(), project.getVersion(), userName);
    }

    /**
     * Creates directory for storage.
     *
     * @param parentDirectory
     * @return true when parentDirectory could not be created.
     */
    boolean createParentDirectory(final File parentDirectory) {
<span class="pc bpc" id="L191" title="1 of 4 branches missed.">        return parentDirectory.exists() || parentDirectory.mkdirs();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.4.201502262128</span></div></body></html>